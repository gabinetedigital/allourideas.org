  var loadedTime = new Date();

  pode_adicionar_nova_idea = true;
  default_text_box = 'Inclua uma nova ideia aqui...'

  if(parent._verifica_pode_adicionar_idea){
    pode_adicionar_nova_idea = parent._verifica_pode_adicionar_idea();
  }else{
    //Se nao tem o method no parent, teoricamente esth fora do GD.
    $(".add-idea-row").remove();
  };
  _enviar_contrib_automatica = function(){
    //Chamda do click no botão enviar de novas ideias para enviar automaticamente qdo um
    //usuario estiver logando no ao mesmo tempo que contribuindo.
    $(".add_idea").find('button').click();
  }
  trata_botao_adicionar_ideia = function(pode){
    if(!pode){
      default_text_box = 'Você precisa de cadastro para enviar uma nova ideia.';
    }else{
      default_text_box = 'Inclua uma nova ideia aqui...';
    };
    $('#new_idea_field').attr('placeholder',default_text_box);
    $('#default_text').val(default_text_box);
    pode_adicionar_nova_idea = pode;
  };

  if(!pode_adicionar_nova_idea){
    default_text_box = 'Você precisa de cadastro para enviar uma nova ideia.';
  }else{
    default_text_box = 'Inclua uma nova ideia aqui...';
  };
  $('#new_idea_field').attr('placeholder',default_text_box);
  $('#default_text').val(default_text_box);


  handle_history_events = function(event){
    var left_side_text = $('#left_side_text').val();
    var right_side_text = $('#right_side_text').val();

    // This only takes effect if the page is loaded from back or forward buttons
    if(left_side_text && left_side_text != "blank_history" && left_side_text != $('.leftside').html()){
      $('.leftside').html(left_side_text)
    }
    if(right_side_text && right_side_text != "blank_history" && right_side_text != $('.rightside').html()){
      $('.rightside').html(right_side_text)
    }
  }

  handle_history_events();

  $('#the_add_box .new_idea_field').jqEasyCounter({target: '#the_add_box .new_idea_counter'});
  $('#the_add_box button').hide();

  $('#the_add_box').on('focus', 'textarea', function(ev) {
    $('#the_add_box button').show();
    $('#the_add_box .new_idea_counter').show();
  });
  $('#the_add_box').on('blur', 'textarea', function(ev) {
    if ($.trim($(ev.currentTarget).val()).length === 0) {
      $('#the_add_box button').fadeOut();
    }
    $('#the_add_box .new_idea_counter').fadeOut();
  });
  // allow enter to add idea
  $('#the_add_box').on('keypress', 'textarea', function(ev) {
    $('#the_add_box button').show();
    if (ev.which == 13) {
      ev.preventDefault();
      $('#the_add_box button').click();
    }
  });

  // handle submit on add new idea box
  $('#the_add_box').on('click', 'button', function(ev) {
    ev.preventDefault();
    if(pode_adicionar_nova_idea){
      var button = $(ev.currentTarget);
      button.addClass('disabled');
      var box = $(ev.delegateTarget);
      var new_idea = box.find('.new_idea_field').val();
      var default_text = $('#default_text').val();
      var question_id = button.data("question_id");

      $('.example_notice').hide();

      // verify new idea is not blank, default or longer than 140 characters
      if (new_idea == 'Add your own idea here...' || new_idea == '' || new_idea == default_text) {
        alert('<%=t('vote.submit_idea_default_error') %>');
        return;
      }
      if (new_idea.length > <%= Const::MAX_ITEM_LENGTH %>) {
        alert('<%=t('vote.submit_idea_too_long_error') %>');
        return;
      }

      $('.tellmearea').html('');
      var data = {authenticity_token : AUTH_TOKEN, new_idea: new_idea};
      var url  = '/questions/' + question_id + '/add_idea.js?locale=<%= I18n.locale %>';
      $.post(url, data, function(data){

        //Chama o callback do GD para gravar a con tribuição
        if(parent._callback_contribution){
          parent._callback_contribution(data.choice_id,data.choice_data);
        }
        button.removeClass('disabled');
        // keypress is for counter
        $('#new_idea_field').val('').show().keypress().blur();

        var responseText = '';
        if (data['choice_status'] == 'active') {
          responseText = '<%= t('vote.submit_idea_thankyou') %>';
          current_item_count = $('#item_count').html();
          $('#item_count').html(increment(current_item_count));
        }
        else {
          responseText = '<%= t('vote.idea_sent_for_review') %>';
        }
        box.find('.idea-success p').html(responseText);
        box.find('.idea-success').show();
        setTimeout(function() {
          box.find('.idea-success').hide(300);
        }, 5 * 1000);

      }, "json");
    }else{
      if(parent._chama_tela_login){
        parent._chama_tela_login();
      }
    }
  });


    // creates new idea vote buttons and slide them in, while
    // sliding out the old idea vote buttons
    function loadNewPrompts(data) {
      if (data["redirect"]) {
        window.location.replace(data["redirect"]);
      }
    }

    bixcoito = $.cookie('votei');
    if(bixcoito) {
        console.log(bixcoito);
    }
    else {
        console.log("Olá, você ainda não votou!");
    }

    if(bixcoito == 20) {
        $('#votou').modal('show');
    }


    $('.votebox').on('click', '.vote-table-div', function(event){
      event.preventDefault();


      bixcoito = $.cookie('votei');
      if(!bixcoito || isNaN(bixcoito) ) {
          bixcoito = 0;
      }

      $.cookie('votei', parseInt(bixcoito) + 1);

      var winningLink = $(event.currentTarget);
      // return early if disabled or not btn-primary
      if (!winningLink.not('.disabled').is('.vote-table-div')) {
        return;
      }
      var losingLink  = winningLink.closest('.votebox').find('.vote-table-div').not(winningLink);
      var winningSide = winningLink.data('side').replace('side', '');

      $('.votebox').off('click');
      winningLink.find('.btn').addClass('btn-success').addClass('disabled');
      winningLink.find('.vote-table').addClass('escolhida');
      losingLink.find('.btn').addClass('disabled');
      losingLink.find('.vote-table').removeClass('essa');

      var currentTime = new Date();
      var time_viewed = currentTime - loadedTime
      var the_locale = "<%= I18n.locale %>"


      var question_id = winningLink.data("question_id");

      var prompt_id = $('#prompt_id').val()
      var appearance_lookup = $('#appearance_lookup').val()
      $('.tellmearea').html('');

      $.ajax({
        type: "post",
        url: '/questions/' + question_id + '/prompts/' + prompt_id + '/vote.js' + '?locale=' + the_locale,
        dataType: "json",
        timeout: 10000,
        data: {
          'authenticity_token' : AUTH_TOKEN,
          'time_viewed' : time_viewed,
          'prompt_id': prompt_id,
          'appearance_lookup': appearance_lookup,
          'direction' : winningSide
        },
        error: function(request,error) {
          winningLink.removeClass('btn-success').removeClass('disabled');
          losingLink.removeClass('disabled');
          if (error == "timeout") {
            $('.tellmearea').html('<%= t('vote.vote_timeout_error')%>').effect("highlight", {color: '#ff0000'}, 1500);
          }
          else {
            $('.tellmearea').html("<%= t('vote.vote_other_error') %>").effect("highlight", {color: '#ff0000'}, 1500);
          }

          loadedTime = new Date(); //reset loaded time
        },
        success: function(data){
          loadNewPrompts(data);
        }// End success
      }); // End ajax method
    });

    // handle can't decide click
    $('#cant_decide_options').on('click', 'button', function(ev) {
      ev.preventDefault();
      var target = $(ev.currentTarget);
      var reason = target.data('reason');
      var question_id = target.data("questionid");
      if (!reason || !question_id) {
        return;
      }
      $('.btn-vote-idea').addClass('disabled');
      var time_viewed = (new Date()) - loadedTime
      var prompt_id = $('#prompt_id').val()
      var appearance_lookup = $('#appearance_lookup').val()

      $('.example_notice').hide();
      $('.tellmearea').html('');
      $.blockUI({ message: null, fadeIn: 0, fadeOut:  0, overlayCSS:  {
          backgroundColor: '#000',
          opacity:         0.0
      }});

      var postData = {
        'authenticity_token' : AUTH_TOKEN,
        'cant_decide_reason' : reason,
        'time_viewed' : time_viewed,
        'appearance_lookup': appearance_lookup
      };
      var url = '/questions/' + question_id + '/prompts/' + prompt_id + '/skip.js' + '?locale=<%= I18n.locale %>';
      $.post(url, postData, function(data) {
        loadNewPrompts(data);
      },"json");
    });


    // handle flag inappropriate clicks
    // flag_side is used later on submit to determine which choice
    // is being marked as inappropriate
    var flag_side = null;
    $('.flag_link').click(function(ev) {
      ev.preventDefault();
      flag_side = $(this).attr('id');
      $('#flag_inappropriate textarea').val('');
    });

    $('#flag_inappropriate').on('click', 'button', function(ev) {
      var user_text = null;
      user_text = $('#flag_inappropriate textarea').val();
      if (!user_text) {
        alert("You must include an explanation");
        return;
      }
      $('#flag_inappropriate').modal('hide');

      var time_viewed = (new Date()) - loadedTime
      var prompt_id = $('#prompt_id').val();
      var appearance_lookup = $('#appearance_lookup').val();
      var question_id = $(ev.currentTarget).data('question_id');
      $('.btn-vote-idea').addClass('disabled');

      $('.example_notice').hide();
      $('.tellmearea').html('');

      $.blockUI({ message: null, fadeIn: 0, fadeOut:  0, overlayCSS:  {
          backgroundColor: '#000',
          opacity:         0.0
      }});

      var url = '/questions/' + question_id + '/prompts/' + prompt_id + '/flag.js'+ '?locale=<%= I18n.locale %>';
      var postData = {
        'authenticity_token' : AUTH_TOKEN,
        'flag_reason' : user_text,
        'time_viewed' : time_viewed,
        'side': flag_side,
        'appearance_lookup': appearance_lookup
      };
      $.post(url, postData, function(data) {
        loadNewPrompts(data);
      }, "json");
    });


   $('#pq').hide();
    $('#pro').hide();

    $('.porque').click(function(){
        $('#pri').hide();
        $('#pro').hide();
        $('#como').hide();
        $('#pq').fadeIn();
    });

    $('.processo').click(function(){
        $('#pq').hide();
        $('#pri').hide();
        $('#como').hide();
        $('#pro').fadeIn();
    });

    $('.comofunciona').click(function(){
        $('#pq').hide();
        $('#pro').hide();
        $('#pri').hide();
        $('#como').fadeIn();
    });

    $('.go1').click(function(){
        $('.step1').fadeIn();
        $('.step2').hide();
        $('.step3').hide();
        $('.step4').hide();
        $('.go1 a').addClass('active');
        $('.go4 a').removeClass('active');
        $('.go2 a').removeClass('active');
        $('.go3 a').removeClass('active');
    });

    $('.go2').click(function(){
        $('.step2').fadeIn();
        $('.step1').hide();
        $('.step3').hide();
        $('.step4').hide();
        $('.go2 a').addClass('active');
        $('.go1 a').removeClass('active');
        $('.go4 a').removeClass('active');
        $('.go3 a').removeClass('active');
    });

    $('.go3').click(function(){
        $('.step3').fadeIn();
        $('.step2').hide();
        $('.step1').hide();
        $('.step4').hide();
        $('.go3 a').addClass('active');
        $('.go1 a').removeClass('active');
        $('.go2 a').removeClass('active');
        $('.go4 a').removeClass('active');
    });

    $('.go4').click(function(){
        $('.step4').fadeIn();
        $('.step2').hide();
        $('.step3').hide();
        $('.step1').hide();
        $('.go4 a').addClass('active');
        $('.go1 a').removeClass('active');
        $('.go2 a').removeClass('active');
        $('.go3 a').removeClass('active');
    });

